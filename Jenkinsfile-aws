pipeline {
    agent any

    triggers {
        pollSCM '* * * * *'
    }


    stages {
stage('Build') {
    steps {
        script {
            if (isUnix()) {
                error('Este script de pipeline deve ser executado apenas no Windows.')
            }
            def gradlewCmd = 'gradlew.bat'

            // Define the Gradle cache path
            String gradleCachePath = "${env.USERPROFILE}\\.gradle\\caches"
            // Uncomment the lines below if you need to clear the Gradle cache before building
            // echo "Deleting Gradle caches from: ${gradleCachePath}"
             //bat "${gradlewCmd} --stop"
             //bat "rmdir /s /q ${gradleCachePath.replaceAll('\\\\', '\\\\\\\\')}"

            // Clean and build the project
            bat "${gradlewCmd} clean build"

            // Update PATH to include Git (adjust as necessary for your system)
            env.PATH = "C:\\Developer\\Tools\\git\\mingw64\\bin;" + env.PATH

            // Checkout the master branch
            bat "git checkout master"

            // Check the status of the repository
            bat "git status"

            // Pull the latest changes from the remote master branch
            bat "git pull origin master --rebase"

            // Add all changes to the staging area
           // bat "git add . "

            // Commit the changes with a generic commit message
            //bat "git commit -m 'Commit'"
            bat "${gradlewCmd} --stop"
            // Push the changes to the remote repository
          //  bat "git push"



            // Perform the release using Gradle. Adjust versions as necessary.
            bat "${gradlewCmd} release -Prelease.useAutomaticVersion=true -Prelease.releaseVersion=1.0.0 -Prelease.newVersion=1.1.0-SNAPSHOT"
        }
    }
}


        stage('Test') {
            steps {
                script {
                    def gradlewCmd = 'gradlew.bat'
                    bat "${gradlewCmd} test"
                }
            }
        }
        stage('Build Docker image') {
         environment {
                DOCKER_HUB_LOGIN = credentials('docker-hub')
            }
            steps {
                script {
                   def gradlewCmd = 'gradlew.bat'


                               // Build the Docker image
                               bat "${gradlewCmd} docker "

                               // Docker login to Docker Hub
                               bat "docker login --username=${env.DOCKER_HUB_LOGIN_USR} --password=${env.DOCKER_HUB_LOGIN_PSW}"

                               // Push the Docker image to Docker Hub
                               bat "${gradlewCmd} dockerPush -PdockerHubUsername=${env.DOCKER_HUB_LOGIN_USR}"
                }
            }
        }
stage('Deploy to AWS') {
    environment {
        DOCKER_HUB_LOGIN = credentials('docker-hub')
    }
    steps {
        script {
            try {

                        // Call your Gradle build
                      //  bat "gradlew.bat build  writeDockerImageNameToFile" // Assuming you're using Windows batch command

                        // Read the imageName from the file
                        //def dockerImageName = readFile("${WORKSPACE}/build/dockerImageName.txt").trim()

                        // Now dockerImageName contains your Docker image name, and you can use it in subsequent steps
                        //echo "Docker Image Name: ${dockerImageName}"

                        // Example: Pulling the latest Docker image
                       // bat "docker pull ${dockerImageName}"

                withAWS(credentials: 'aws-credentials', region: 'eu-central-1') {
                    bat "gradlew.bat awsCfnMigrateStack awsCfnWaitStackComplete -PsubnetId=${env.SUBNET_ID} -PdockerHubUsername=${env.DOCKER_HUB_LOGIN_USR} -Pregion=${env.AWS_REGION}"
                }
            } catch (Exception e) {
                // Log the error
                echo "Deployment failed: ${e.getMessage()}"
            }
        }
    }
}

    }
}

// Utility method to check if the OS is Unix-like
def isUnix() {
    return !System.getProperty('os.name').toLowerCase().contains('windows')
}
